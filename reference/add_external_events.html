<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Add External Event Attributes to Unemployment Periods — add_external_events • vecshift</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Roboto-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Add External Event Attributes to Unemployment Periods — add_external_events"><meta name="description" content="Adds external event attributes to unemployment periods in vecshift output by matching
events with unemployment segments (arco == 0). Events are matched using either
temporal overlap or nearest neighbor strategies. The function can also create
synthetic unemployment periods for persons present in external events but not
in the main employment data."><meta property="og:description" content="Adds external event attributes to unemployment periods in vecshift output by matching
events with unemployment segments (arco == 0). Events are matched using either
temporal overlap or nearest neighbor strategies. The function can also create
synthetic unemployment periods for persons present in external events but not
in the main employment data."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">vecshift</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.0.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/understanding-date-logic.html">Understanding Date Logic</a></li>
    <li><a class="dropdown-item" href="../articles/status-classification.html">Employment Status Classification</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/gmontaletti/vecshift/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Add External Event Attributes to Unemployment Periods</h1>
      <small class="dont-index">Source: <a href="https://github.com/gmontaletti/vecshift/blob/main/R/add_external_events.R" class="external-link"><code>R/add_external_events.R</code></a></small>
      <div class="d-none name"><code>add_external_events.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Adds external event attributes to unemployment periods in vecshift output by matching
events with unemployment segments (arco == 0). Events are matched using either
temporal overlap or nearest neighbor strategies. The function can also create
synthetic unemployment periods for persons present in external events but not
in the main employment data.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">add_external_events</span><span class="op">(</span></span>
<span>  <span class="va">vecshift_data</span>,</span>
<span>  <span class="va">external_events</span>,</span>
<span>  event_matching_strategy <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"overlap"</span>, <span class="st">"nearest"</span><span class="op">)</span>,</span>
<span>  create_synthetic_unemployment <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  synthetic_unemployment_duration <span class="op">=</span> <span class="fl">730L</span>,</span>
<span>  date_columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>start <span class="op">=</span> <span class="st">"event_start"</span>, end <span class="op">=</span> <span class="st">"event_end"</span><span class="op">)</span>,</span>
<span>  event_name_column <span class="op">=</span> <span class="st">"event_name"</span>,</span>
<span>  person_id_column <span class="op">=</span> <span class="st">"cf"</span>,</span>
<span>  memory_safe <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  chunk_size <span class="op">=</span> <span class="fl">10000L</span>,</span>
<span>  progress <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-vecshift-data">vecshift_data<a class="anchor" aria-label="anchor" href="#arg-vecshift-data"></a></dt>
<dd><p>A data.table output from vecshift() containing temporal
employment segments with required columns: cf, inizio, fine, arco, prior,
id, over_id, durata. Optional: stato column for employment status.</p></dd>


<dt id="arg-external-events">external_events<a class="anchor" aria-label="anchor" href="#arg-external-events"></a></dt>
<dd><p>A data.table containing external events with person
identifiers and event information. Must contain the person_id_column and
event_name_column, plus at least one date column specified in date_columns.</p></dd>


<dt id="arg-event-matching-strategy">event_matching_strategy<a class="anchor" aria-label="anchor" href="#arg-event-matching-strategy"></a></dt>
<dd><p>Character. Matching strategy to use:</p><ul><li><p><code>"overlap"</code>: Match events that temporally overlap with unemployment periods</p></li>
<li><p><code>"nearest"</code>: Find nearest unemployment period when no overlap exists</p></li>
</ul></dd>


<dt id="arg-create-synthetic-unemployment">create_synthetic_unemployment<a class="anchor" aria-label="anchor" href="#arg-create-synthetic-unemployment"></a></dt>
<dd><p>Logical. Whether to create synthetic
unemployment periods for persons in external_events but not in vecshift_data
(default: FALSE).</p></dd>


<dt id="arg-synthetic-unemployment-duration">synthetic_unemployment_duration<a class="anchor" aria-label="anchor" href="#arg-synthetic-unemployment-duration"></a></dt>
<dd><p>Integer. Maximum duration in days for
synthetic unemployment periods (default: 730L for 2 years).</p></dd>


<dt id="arg-date-columns">date_columns<a class="anchor" aria-label="anchor" href="#arg-date-columns"></a></dt>
<dd><p>Named character vector specifying date column names in
external_events. Names should be "start" and optionally "end".
Default: c(start = "event_start", end = "event_end").</p></dd>


<dt id="arg-event-name-column">event_name_column<a class="anchor" aria-label="anchor" href="#arg-event-name-column"></a></dt>
<dd><p>Character. Name of column in external_events containing
event names/types (default: "event_name").</p></dd>


<dt id="arg-person-id-column">person_id_column<a class="anchor" aria-label="anchor" href="#arg-person-id-column"></a></dt>
<dd><p>Character. Name of column in external_events containing
person identifiers that match the 'cf' column in vecshift_data (default: "cf").</p></dd>


<dt id="arg-memory-safe">memory_safe<a class="anchor" aria-label="anchor" href="#arg-memory-safe"></a></dt>
<dd><p>Logical. Enable memory-safe mode for large datasets.
When TRUE, processes data in chunks to reduce peak memory usage at the cost
of some performance (default: FALSE).</p></dd>


<dt id="arg-chunk-size">chunk_size<a class="anchor" aria-label="anchor" href="#arg-chunk-size"></a></dt>
<dd><p>Integer. Number of persons to process per chunk when
memory_safe = TRUE (default: 10000L).</p></dd>


<dt id="arg-progress">progress<a class="anchor" aria-label="anchor" href="#arg-progress"></a></dt>
<dd><p>Logical. Show progress messages for long-running operations
(default: FALSE).</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A data.table with the same structure as vecshift_data, extended with:</p><ul><li><p>New columns: "event_name_attribute" (1 for matched unemployment periods, 0 otherwise)</p></li>
<li><p>New columns: "event_name_distance" (days between event and unemployment period)</p></li>
<li><p>New columns: "event_name_match_quality" (overlap, nearest, or none)</p></li>
<li><p>Synthetic unemployment periods if create_synthetic_unemployment = TRUE</p></li>
</ul><p>Maintains original ordering by cf and temporal sequence.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The function implements two matching strategies:</p><ul><li><p><strong>Overlap matching</strong>: Events that temporally overlap with unemployment periods</p></li>
<li><p><strong>Nearest matching</strong>: When no overlap exists, finds the nearest unemployment period</p></li>
</ul><p>For each external event, the function:</p><ul><li><p>Creates a new column "event_name_attribute" with value 1 for matched periods</p></li>
<li><p>Adds distance/quality metrics in additional columns</p></li>
<li><p>Maintains all original vecshift data integrity</p></li>
<li><p>Handles multiple events per person</p></li>
</ul><p><strong>Synthetic Unemployment Creation</strong>:
When create_synthetic_unemployment = TRUE, the function creates unemployment
periods for persons in external_events but not in vecshift_data:</p><ul><li><p>Creates periods up to synthetic_unemployment_duration days</p></li>
<li><p>Uses max(fine) from main dataset as the reference endpoint</p></li>
<li><p>Follows vecshift formatting conventions</p></li>
</ul><p><strong>Memory Optimization</strong>:
The function includes several memory optimization strategies:</p><ul><li><p>In-place modifications using data.table reference semantics</p></li>
<li><p>Chunked processing for large datasets when memory_safe = TRUE</p></li>
<li><p>Early filtering to reduce intermediate object sizes</p></li>
<li><p>Efficient rolling joins for nearest neighbor matching</p></li>
<li><p>Immediate cleanup of temporary objects</p></li>
</ul></div>
    <div class="section level2">
    <h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a></h2>
    <p>The function optimizes performance using data.table operations and follows
vecshift coding conventions. It handles edge cases such as:</p><ul><li><p>Events with only start dates (treated as single-day events)</p></li>
<li><p>Multiple events per person</p></li>
<li><p>Persons with no unemployment periods</p></li>
<li><p>Date format consistency between datasets</p></li>
<li><p>Proper integration with over_id consolidation logic</p></li>
</ul><p>For very large datasets (&gt;1M records), consider using memory_safe = TRUE
to enable chunked processing that reduces peak memory usage.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="vecshift.html">vecshift</a></code> for the main temporal transformation function
<code><a href="add_unemployment_periods.html">add_unemployment_periods</a></code> for adding unemployment periods</p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create sample employment data</span></span></span>
<span class="r-in"><span><span class="va">employment_dt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  id <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span>,</span></span>
<span class="r-in"><span>  cf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ABC123"</span>, <span class="st">"ABC123"</span>, <span class="st">"DEF456"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  INIZIO <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2023-01-01"</span>, <span class="st">"2023-07-01"</span>, <span class="st">"2023-03-01"</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  FINE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2023-03-31"</span>, <span class="st">"2023-12-31"</span>, <span class="st">"2023-06-30"</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Transform to vecshift format</span></span></span>
<span class="r-in"><span><span class="va">vecshift_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="vecshift.html">vecshift</a></span><span class="op">(</span><span class="va">employment_dt</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create external events (e.g., training programs)</span></span></span>
<span class="r-in"><span><span class="va">training_events</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>  cf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ABC123"</span>, <span class="st">"DEF456"</span>, <span class="st">"GHI789"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  event_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"training_program"</span>, <span class="st">"training_program"</span>, <span class="st">"training_program"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  event_start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2023-05-15"</span>, <span class="st">"2023-08-01"</span>, <span class="st">"2023-04-01"</span><span class="op">)</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  event_end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2023-05-25"</span>, <span class="st">"2023-08-15"</span>, <span class="st">"2023-04-15"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Add external events with overlap matching</span></span></span>
<span class="r-in"><span><span class="va">result_with_events</span> <span class="op">&lt;-</span> <span class="fu">add_external_events</span><span class="op">(</span></span></span>
<span class="r-in"><span>  vecshift_data <span class="op">=</span> <span class="va">vecshift_result</span>,</span></span>
<span class="r-in"><span>  external_events <span class="op">=</span> <span class="va">training_events</span>,</span></span>
<span class="r-in"><span>  event_matching_strategy <span class="op">=</span> <span class="st">"overlap"</span>,</span></span>
<span class="r-in"><span>  date_columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>start <span class="op">=</span> <span class="st">"event_start"</span>, end <span class="op">=</span> <span class="st">"event_end"</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>  event_name_column <span class="op">=</span> <span class="st">"event_name"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Check the new attribute columns</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result_with_events</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span><span class="va">cf</span>, <span class="va">arco</span>, <span class="va">training_program_attribute</span>, </span></span>
<span class="r-in"><span>                             <span class="va">training_program_distance</span>, <span class="va">training_program_match_quality</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Add events with synthetic unemployment for missing persons</span></span></span>
<span class="r-in"><span><span class="va">result_with_synthetic</span> <span class="op">&lt;-</span> <span class="fu">add_external_events</span><span class="op">(</span></span></span>
<span class="r-in"><span>  vecshift_data <span class="op">=</span> <span class="va">vecshift_result</span>,</span></span>
<span class="r-in"><span>  external_events <span class="op">=</span> <span class="va">training_events</span>,</span></span>
<span class="r-in"><span>  event_matching_strategy <span class="op">=</span> <span class="st">"overlap"</span>,</span></span>
<span class="r-in"><span>  create_synthetic_unemployment <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  synthetic_unemployment_duration <span class="op">=</span> <span class="fl">365L</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Use nearest neighbor matching when overlap is not sufficient</span></span></span>
<span class="r-in"><span><span class="va">result_nearest</span> <span class="op">&lt;-</span> <span class="fu">add_external_events</span><span class="op">(</span></span></span>
<span class="r-in"><span>  vecshift_data <span class="op">=</span> <span class="va">vecshift_result</span>,</span></span>
<span class="r-in"><span>  external_events <span class="op">=</span> <span class="va">training_events</span>,</span></span>
<span class="r-in"><span>  event_matching_strategy <span class="op">=</span> <span class="st">"nearest"</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># For very large datasets, use memory-safe mode</span></span></span>
<span class="r-in"><span><span class="va">result_large</span> <span class="op">&lt;-</span> <span class="fu">add_external_events</span><span class="op">(</span></span></span>
<span class="r-in"><span>  vecshift_data <span class="op">=</span> <span class="va">large_vecshift_result</span>,</span></span>
<span class="r-in"><span>  external_events <span class="op">=</span> <span class="va">large_training_events</span>,</span></span>
<span class="r-in"><span>  event_matching_strategy <span class="op">=</span> <span class="st">"overlap"</span>,</span></span>
<span class="r-in"><span>  memory_safe <span class="op">=</span> <span class="cn">TRUE</span>,</span></span>
<span class="r-in"><span>  chunk_size <span class="op">=</span> <span class="fl">5000L</span>,</span></span>
<span class="r-in"><span>  progress <span class="op">=</span> <span class="cn">TRUE</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/gmontaletti" class="external-link">Giampaolo Montaletti</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

